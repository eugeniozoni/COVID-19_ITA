---
title: "COVID-19  - Italy"
author:
  name: Eugenio Zoni
date: "`r format(Sys.time(), '%Y %B, %d')`"
output:
  html_document:
    df_print: paged
    number_sections: no
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, echo=FALSE, message=FALSE, results="hide"}
knitr::opts_chunk$set(cache = FALSE, error= FALSE)
```

## Objective

The objective is to represent the current and future incidence for COVID-19 in Italy. For this, we use the *projections* and the *incidence* library. Details about the algorithm used in the package are available here: https://cloud.r-project.org/web/packages/projections/index.html and published here: https://www.sciencedirect.com/science/article/pii/S1755436517300245?via%3Dihub#fig0010 

**IMPORTANT**
In this workflow we employ standard functions within the *projections* and *incidence* package to represent the evolution of the infection and understand its possible evolution. The data and processing represented in this workflow should be taken as starting point and serve as initial structure of a code for more sofisticated processing of these data. 

## Load libraries
```{r , warning=FALSE, message=FALSE}
library(projections)
library(incidence)
library(outbreaks)
library(RCurl)
library(dplyr)
library(ggplot2)
library(distcrete)
library(epitrix)
library(pastecs)
library(tidyr)
library(magrittr)
library(EpiEstim)

getwd()

```

## Load data

Data related to current situation in Italy are updated daily by the italian "Protezione Civile" and downloaded from here: https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-andamento-nazionale/dpc-covid19-ita-andamento-nazionale.csv. First we load the data in R and we save them as `.csv` file.
```{r , warning=FALSE, message=FALSE}
URL <- "https://raw.githubusercontent.com/pcm-dpc/COVID-19/master/dati-andamento-nazionale/dpc-covid19-ita-andamento-nazionale.csv"
x <- getURL(URL)
covid_19_ITA <- read.csv(textConnection(x))
write.csv(`covid_19_ITA`, "covid_19_ITA.csv")
```

## Clean-up the data

We rename columns:
```{r , warning=FALSE, message=FALSE}
mydata_ITA<-dplyr::rename(covid_19_ITA,
                   
                   dates_D_T = data,
                   country = stato,
                   hospitalized_symptomatic = ricoverati_con_sintomi,
                   icu = terapia_intensiva,
                   hospitalized_total = totale_ospedalizzati,
                   quarantine_home = isolamento_domiciliare,
                   positive_total_up_to_date = totale_attualmente_positivi,
                   new_positive_up_to_date = nuovi_attualmente_positivi,
                   dismissed_recovered = dimessi_guariti,
                   deaths = deceduti,
                   total_cases = totale_casi,
                   tests = tamponi
                   )
```

The dates include time (hrs). Therefore, we remove the string related to time of the day when data are published.
```{r , warning = FALSE, message=FALSE}
mydata_ITA <- mydata_ITA %>%
  dplyr::mutate(dates = gsub(pattern = "T.*", replacement = "", dates_D_T))
mydata_ITA
```

Then we need to format the data in a suitable format to generate the `incidence` object. For this we make a new df. This df will have a number of rows equal to the `new_positive_up_to_date` column. In other words, we need to have a df where each row corresponds to one patient.
```{r , warning=FALSE, message=FALSE}
df.expanded_ITA <- mydata_ITA[rep(row.names(mydata_ITA), mydata_ITA$new_positive_up_to_date), 2:15]
```

We also make another df with the same logic above, but we use the `positive_total_up_to_date` column instead. This df will be used to subset the patient based on their current condition.
```{r , warning=FALSE, message=FALSE}
df.expanded_total_ITA <- mydata_ITA[rep(row.names(mydata_ITA), mydata_ITA$positive_total_up_to_date), 2:15]
```

Then we create a new column `groups` where we subset the data of the **new cases** by three categories: * **hospital** : here we include the patients identified as *hospitalized_symptomatic*
* **icu** : here we include the patients in intensive care (*icu*)
* **home** : here we include the patients that are in *quarantine_home*
```{r , warning=FALSE, message=FALSE}
groups<-c(replicate(101, "hospital"), replicate(26, "icu"), replicate(94, "home"),
          replicate(114, "hospital"), replicate(35, "icu"), replicate(162, "home"),
          replicate(128, "hospital"), replicate(36, "icu"), replicate(221, "home"),
          replicate(248, "hospital"), replicate(56, "icu"), replicate(284, "home"),
          replicate(345, "hospital"), replicate(64, "icu"), replicate(412, "home"),
          replicate(401, "hospital"), replicate(105, "icu"), replicate(543, "home"),
          replicate(639, "hospital"), replicate(140, "icu"), replicate(798, "home"),
          replicate(742, "hospital"), replicate(166, "icu"), replicate(927, "home"),
          replicate(1034, "hospital"), replicate(229, "icu"), replicate(1000, "home"),
          replicate(1346, "hospital"), replicate(295, "icu"), replicate(1065, "home"),
          replicate(1790, "hospital"), replicate(351, "icu"), replicate(1155, "home"),
          replicate(2394, "hospital"), replicate(462, "icu"), replicate(1060, "home"),
          replicate(2651, "hospital"), replicate(567, "icu"), replicate(1843, "home"),
          replicate(3557, "hospital"), replicate(650, "icu"), replicate(2180, "home"),
          replicate(4316, "hospital"), replicate(733, "icu"), replicate(2936, "home"),
          replicate(5038, "hospital"), replicate(877, "icu"), replicate(2599, "home"),
          replicate(5838, "hospital"), replicate(1028, "icu"), replicate(3724, "home"),
          replicate(6650, "hospital"), replicate(1153, "icu"), replicate(5036, "home"),
          replicate(7426, "hospital"), replicate(1328, "icu"), replicate(6201, "home"),
          replicate(8372, "hospital"), replicate(1518, "icu"), replicate(7860, "home"),
          replicate(9663, "hospital"), replicate(1672, "icu"), replicate(9268, "home"),
          replicate(11025, "hospital"), replicate(1851, "icu"), replicate(10197, "home"),
          replicate(12894, "hospital"), replicate(2060, "icu"), replicate(11108, "home"),
          replicate(14363, "hospital"), replicate(2257, "icu"), replicate(12090, "home"),
          replicate(15757, "hospital"), replicate(2498, "icu"), replicate(14935, "home"),
          replicate(16020, "hospital"), replicate(2655, "icu"), replicate(19185, "home"),
          replicate(17708, "hospital"), replicate(2857, "icu"), replicate(22116, "home"),
          replicate(19846, "hospital"), replicate(3009, "icu"), replicate(23783, "home"),
          replicate(20692, "hospital"), replicate(3204, "icu"), replicate(26522, "home"),
          replicate(21937, "hospital"), replicate(3396, "icu"), replicate(28697, "home"),
          replicate(23112, "hospital"), replicate(3489, "icu"), replicate(30920, "home"),
          replicate(24753, "hospital"), replicate(3612, "icu"), replicate(33648, "home"),
          replicate(26029, "hospital"), replicate(3732, "icu"), replicate(36653, "home"),
          replicate(26676, "hospital"), replicate(3856, "icu"), replicate(39533, "home"),
          replicate(27386, "hospital"), replicate(3906, "icu"), replicate(42588, "home")
          )
df.expanded_total_ITA$groups<-groups
```

## Daily incidence

With the function `incidence` we can compute the daily incidence by setting the variable `interval` = 1. 
**IMPORTANT : ** It should be noted that for this we include only the df generated by calculating the `new_positive_up_to_date`
```{r , warning=FALSE, message=FALSE}
dat <- as.Date(df.expanded_ITA$dates)
class(dat)
i_ITA<-incidence(dat, interval = 1)
plot(i_ITA, n_breaks = 8)
```

We can also show the `incidence` obtained using the `df.expanded_total` as this will allow us to represent the distribution of the different groups.

**IMPORTANT : ** there is not information in the data from the italian "Protezione Civile" related to the subset of the `new_positive_up_to_date`. In other words we do not know, among the new daily cases, how many patients end up in icu or at home or in the hospital. Therefore, this plot might be usefull to represent the trend of the data, but not suitable to calculate the incidence which we base on the numebr of new cases only.
```{r , warning=FALSE, message=FALSE}
dat_total <- as.Date(df.expanded_total_ITA$dates)
class(dat_total)
i_total_ITA<-incidence(dat_total, interval = 1, groups= df.expanded_total_ITA$groups)
plot(i_total_ITA)
```

We also make the same incidence object as above but without groups to be used later for the prediction:
```{r , warning=FALSE, message=FALSE}
i_total_ITA_ng<-incidence(dat_total, interval = 1)
plot(i_total_ITA_ng)
```

## Modelling incidence

As explained in the vignette of the *incidence* package, incidence data, excluding zeros, can be modelled using log-linear regression of the form: log(y) = r x t + b where y is the incidence, r is the growth rate, t is the number of days since a specific point in time (typically the start of the outbreak), and b is the intercept.
```{r , warning=FALSE, message=FALSE}
early.fit_ITA <-  incidence::fit(i_ITA, split = as.Date("2020-03-10"))
plot(i_ITA, fit = early.fit_ITA) + labs(title = "Observed and modelled incidence of COVID-19", subtitle = "total new positive cases up to date - ITA")
early.fit_ITA
```
From this we can see that doubling time in days has started to increase if we compare the values *before* VS *after* shutdown, which might be an indication that the shutdown is somehow working.

We can also calculate the fit by assuming that the peak of the epidemic already happend at the highest point reached so far:
```{r , warning=FALSE, message=FALSE}
late.fit_ITA <-  incidence::fit(i_ITA, split = as.Date("2020-03-21"))
plot(i_ITA, fit =late.fit_ITA) + labs(title = "Observed and modelled incidence of COVID-19", subtitle = "total new positive cases up to date - ITA")
late.fit_ITA
```

We can also model the incidence estimated with the `positive_total_up_to_date`
```{r , warning=FALSE, message=FALSE}
early.fit_total_ITA <- incidence::fit(i_total_ITA_ng, split = as.Date("2020-03-10"))
plot(i_total_ITA_ng, fit = early.fit_total_ITA) + labs(title = "Observed and modelled incidence of COVID-19", subtitle = "total positive cases up to date - ITA")
early.fit_total_ITA
```
Also for the total cases, if we compare the doubling time in days *before* and *after* the shutdown we can see that this increased even more compared to new cases. This also can indicate that the shutdown is somehow working.

## Serial Interval

We calculate the coefficient of variation (cv) by employing mu and sigma as calculated here: https://www.nejm.org/doi/full/10.1056/NEJMoa2001316. 
```{r , warning=FALSE, message=FALSE}
mu <- 7.5  # days
sigma <- 3.4  # days
params_ITA <- gamma_mucv2shapescale(mu, sigma/mu)

si_ITA <- distcrete("gamma", shape = params_ITA$shape,
                scale = params_ITA$scale,
                interval = 1, w = 0)
si_ITA

plot(1:50, si_ITA$d(1:50), type = "h", lwd = 3, col = "navy",
     main = "Serial interval ITA", xlab = "Days after onset",
     ylab = "Relative infectiousness")
```

Recently, it was proposed that parameters might have changed to mean 5.2 and SD 2.8 days as documented here: https://www.medrxiv.org/content/10.1101/2020.03.05.20031815v1
```{r , warning=FALSE, message=FALSE}
mu <- 5.2  # days
sigma <- 2.8  # days
params_ITA_n <- gamma_mucv2shapescale(mu, sigma/mu)

si_ITA_n <- distcrete("gamma", shape = params_ITA_n$shape,
                scale = params_ITA_n$scale,
                interval = 1, w = 0)
si_ITA_n

plot(1:50, si_ITA_n$d(1:50), type = "h", lwd = 3, col = "navy",
     main = "Serial interval ITA", xlab = "Days after onset",
     ylab = "Relative infectiousness")
```

##Reproduction Number (R0)

Estimation of the reproduction number **before** shutdown calculated from an incidence object generated with the new cases. For this we use the `si_ITA_n` object generated above (mean 5.2 and SD 2.8). For this part we follow the approach proposed by Tim Churches here: https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/ 
```{r , message=FALSE, warning=FALSE}
growth_R0_before <- lm2R0_sample(early.fit_ITA$before$model, si_ITA_n)
hist(growth_R0_before, col = "grey", border = "white", main = "Distribution of R0 - new positive cases, before 2020-03-10")
summary(growth_R0_before)
```

Estimation of the reproduction number **after** shutdown calculated from an incidence object generated with the new cases. Also in this case we use the `si_ITA_n` object generated above (mean 5.2 and SD 2.8):
```{r , message=FALSE, warning=FALSE}
growth_R0_after <- lm2R0_sample(early.fit_ITA$after$model, si_ITA_n)
hist(growth_R0_after, col = "grey", border = "white", main = "Distribution of R0 - new positive cases, after 2020-03-10")
summary(growth_R0_after)
```
By comparing the two median values we can see that R0 is also decreasing slowly over time. 

We can also estimate R0 using the late fit. For this we use the `late.fit_ITA` object generated above with the split point set to 2020-03-21.
```{r , message=FALSE, warning=FALSE}
growth_R0_after_peak <- lm2R0_sample(late.fit_ITA$after$model, si_ITA_n)
hist(growth_R0_after_peak, col = "grey", border = "white", main = "Distribution of R0 - new positive cases, after 2020-03-19")
summary(growth_R0_after_peak)
```

We can do the same by estimating the R number **before** shutdown by using the incidence object generated with the total cases:
```{r , message=FALSE, warning=FALSE}
growth_R0_before_total <- lm2R0_sample(early.fit_total_ITA$before$model, si_ITA_n)
hist(growth_R0_before_total, col = "grey", border = "white", main = "Distribution of R0 - total positive cases, before 2020-03-10")
summary(growth_R0_before_total)
```

And the same with the total incidence object, but with the fitting **after** shutdown:
```{r , message=FALSE, warning=FALSE}
growth_R0_after_total <- lm2R0_sample(early.fit_total_ITA$after$model, si_ITA_n)
hist(growth_R0_after_total, col = "grey", border = "white", main = "Distribution of R0 - total positive cases, after 2020-03-10")
summary(growth_R0_after_total)
```

## Projections

Based on these data we predict future incidence assuming the reproduction numbers estimated above, from today.
```{r , warning=FALSE, message=FALSE}
set.seed(1)
pred_ITA_new_before <- project(i_ITA[1:15], R = median(growth_R0_before), si = si_ITA_n, n_days = 10, n_sim = 1000)
pred_ITA_new_before
plot(pred_ITA_new_before) + labs(title="Future Incidence (R = 1.9) - based on growth of new positive cases in the first 15 days of diffusion")

set.seed(1)
pred_ITA_new_after <- project(i_ITA[16:35], R = median(growth_R0_after_peak), si = si_ITA_n, n_days = 10, n_sim = 1000)
pred_ITA_new_after
plot(pred_ITA_new_after) + labs(title="Future Incidence (R = 0.95) - based on new positive cases growth after shutdown")

set.seed(1)
pred_ITA_new_after_peak <- project(i_ITA[16:35], R = median(growth_R0_after), si = si_ITA_n, n_days = 10, n_sim = 1000)
pred_ITA_new_after_peak
plot(pred_ITA_new_after_peak) + labs(title="Future Incidence (R = 1.3) - based on new positive cases growth after peak")

set.seed(1)
pred_ITA_total_before <- project(i_total_ITA_ng[1:15], R = median(growth_R0_before_total), si = si_ITA_n, n_days = 10, n_sim = 1000)
pred_ITA_total_before
plot(pred_ITA_total_before) + labs(title="Future Incidence (R = 2.5) - based on growth of total positive cases in the first 15 days of diffusion")

set.seed(1)
pred_ITA_total_after <- project(i_total_ITA_ng[16:35], R = median(growth_R0_after_total), si = si_ITA_n, n_days = 10, n_sim = 1000)
pred_ITA_total_after
plot(pred_ITA_new_after) + labs(title="Future Incidence (R = 1.6) - based on total positive cases growth after shutdown")
```

We can add on the real indicende data the projection:
```{r , message=FALSE, warning=FALSE}
plot(i_ITA) %>% add_projections(pred_ITA_new_after, boxplots = FALSE) %>% add_projections(pred_ITA_new_before, boxplots = FALSE) %>% add_projections(pred_ITA_new_after_peak, boxplots = FALSE)

plot(i_total_ITA_ng) %>% add_projections(pred_ITA_total_after, boxplots = FALSE) %>% add_projections(pred_ITA_total_before, boxplots = FALSE)
```

we can also check the cumulative prediction
```{r , warning=FALSE, message=FALSE}
pred_cum_new_before <- cumulate(pred_ITA_new_before) # cumulative predictions
plot(pred_cum_new_before) # plot cumulative predictions

pred_cum_new_after <- cumulate(pred_ITA_new_after) 
plot(pred_cum_new_after) 

pred_cum_total_before <- cumulate(pred_ITA_total_before) 
plot(pred_cum_total_before) 

pred_cum_total_after <- cumulate(pred_ITA_total_after) 
plot(pred_cum_total_after) 
```

And have an estimation of the average cumulative prediction per day:
```{r , warning=FALSE, message=FALSE}
apply(pred_cum_new_before, 1, mean)
apply(pred_cum_new_after, 1, mean)
apply(pred_cum_total_before, 1, mean)
apply(pred_cum_total_after, 1, mean)
```

## Effective reproduction number

For the importance and significance of estimating the effective reproduction number we follow the approach proposed by Tim Chrurches and described here: https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/ 
This is important to track the effectiveness of decision of the government on future steps. 
```{r , warning=FALSE, message=FALSE}
plot_Ri <- function(estimate_R_obj) {
    p_I <- plot(estimate_R_obj, "incid", add_imported_cases = FALSE)  # plots the incidence
    p_SI <- plot(estimate_R_obj, "SI")  # plots the serial interval distribution
    p_Ri <- plot(estimate_R_obj, "R")
    return(gridExtra::grid.arrange(p_I, p_SI, p_Ri, ncol = 1))
}


ITA_new_res_parametric_si <- estimate_R(i_ITA, 
    method = "parametric_si", config = make_config(list(mean_si = 5.2, 
        std_si = 2.8
        )))

plot_Ri(ITA_new_res_parametric_si)
```

As explained in here: https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/ it appears that estimates of **instantanous** R are very high in some days. A possible explaination is that is transmissible **before** the onset of symptoms resulting in a shorter serial interval than expected. So we can recalculate R based on a shorter serial interval, using a mean of just 2.3 days for the SI distribution, and an SD of 1.4.
```{r , warning=FALSE, message=FALSE}
plot_Ri <- function(estimate_R_obj) {
    p_I <- plot(estimate_R_obj, "incid", add_imported_cases = FALSE)  # plots the incidence
    p_SI <- plot(estimate_R_obj, "SI")  # plots the serial interval distribution
    p_Ri <- plot(estimate_R_obj, "R")
    return(gridExtra::grid.arrange(p_I, p_SI, p_Ri, ncol = 1))
}


ITA_new_res_parametric_si <- estimate_R(i_ITA, 
    method = "parametric_si", config = make_config(list(mean_si = 2.3, 
        std_si = 1.4
        )))

plot_Ri(ITA_new_res_parametric_si)
```

This might result in a more optimistic representation of the situation, but the best would be to use a method that allow to incorporate the uncertainty related to serial interval estimation. We use the same strategy employed here: https://timchurches.github.io/blog/posts/2020-02-18-analysing-covid-19-2019-ncov-outbreak-data-with-r-part-1/
i.e. retain the mean SI estimated by Ganyani et al. of 5.2 days, with an SD of 2.8, but let's also allow that mean to vary between 2.3 and 8.4 using a truncated normal distribution with an SD of 2.0. We'll also allow the SD or the SD to vary between 0.5 and 4.0.
```{r , warning=FALSE, message=FALSE}
plot_Ri <- function(estimate_R_obj) {
    p_I <- plot(estimate_R_obj, "incid", add_imported_cases = FALSE)  # plots the incidence
    p_SI <- plot(estimate_R_obj, "SI")  # plots the serial interval distribution
    p_Ri <- plot(estimate_R_obj, "R")
    return(gridExtra::grid.arrange(p_I, p_SI, p_Ri, ncol = 1))
}


ITA_new_res_parametric_si <- estimate_R(i_ITA, 
    method = "uncertain_si", config = make_config(list(mean_si = 5.2, std_mean_si = 2, 
        min_mean_si = 1, max_mean_si = 8.4, std_si = 2.8, std_std_si = 1, 
        min_std_si = 0.5, max_std_si = 4, n1 = 1000, n2 = 1000)))

plot_Ri(ITA_new_res_parametric_si)
```

The conclusion of these three different calculation is that irrespective of the method used to estimate R, this is actually going down and this is a good thing.

We can do the same for the incidence object generated using the total positive cases (and not only the new positive cases up to date):
```{r , warning=FALSE, message=FALSE}
plot_Ri <- function(estimate_R_obj) {
    p_I <- plot(estimate_R_obj, "incid", add_imported_cases = FALSE)  # plots the incidence
    p_SI <- plot(estimate_R_obj, "SI")  # plots the serial interval distribution
    p_Ri <- plot(estimate_R_obj, "R")
    return(gridExtra::grid.arrange(p_I, p_SI, p_Ri, ncol = 1))
}


ITA_total_res_parametric_si <- estimate_R(i_total_ITA_ng, 
    method = "uncertain_si", config = make_config(list(mean_si = 5.2, std_mean_si = 2, 
        min_mean_si = 1, max_mean_si = 8.4, std_si = 2.8, std_std_si = 1, 
        min_std_si = 0.5, max_std_si = 4, n1 = 1000, n2 = 1000)))

plot_Ri(ITA_total_res_parametric_si)
```

And also in this case it is a good thing to see that the R number is decreasing.

## Session Information

The information related to the session can be retrieved here.
```{r}
sessionInfo()
```


